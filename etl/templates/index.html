<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Migration Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/migration.css" rel="stylesheet">
</head>
<body>
<div class="d-flex">
  {% include 'navbar.html' %}

  <main class="content p-4 flex-grow-1">
    <!-- PostgreSQL Connection -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">PostgreSQL Connection</div>
      <div class="card-body">
        <pre class="config-box">{{ pg_conf | tojson(indent=2) }}</pre>
      </div>
    </div>

    <!-- Available Databases -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-secondary text-white">Available Databases</div>
      <div class="card-body">
        <ul id="availableDatabases" class="list-group">
          {% for db in databases %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                {% if db_status[db] == 'up' %}
                  <span class="badge bg-success">Up</span>
                {% else %}
                  <span class="badge bg-danger">Down</span>
                {% endif %}
                <a href="{{ url_for('database_details', db_name=db) }}" class="text-decoration-none">
                  üóÑÔ∏è {{ db }}
                </a>
              </div>
              <div class="btn-group">
                <button id="syncBtn-{{ db }}" class="btn btn-sm btn-primary" onclick="runSync('{{ db }}')">
                  ‚ñ∂ Run Sync
                </button>
                {% if session.get('role') in ['admin', 'operator'] %}
                  <a href="{{ url_for('schedule_page') }}?db={{ db }}" class="btn btn-sm btn-warning">
                    ‚è∞ Schedule
                  </a>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Sync Output -->
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">Sync Output</div>
      <div class="card-body">
        <div id="statusBadge" class="mb-2"></div>
        <label class="form-label">stdout</label>
        <pre id="stdoutBox" class="output-box text-light bg-dark"></pre>
        <label class="form-label mt-3">stderr</label>
        <pre id="stderrBox" class="output-box text-warning bg-dark"></pre>
      </div>
    </div>
  </main>
</div>

<script>
async function runSync(dbName) {
  const btn = document.getElementById(`syncBtn-${dbName}`);
  const statusBadge = document.getElementById('statusBadge');
  const stdoutBox = document.getElementById('stdoutBox');
  const stderrBox = document.getElementById('stderrBox');

  statusBadge.innerHTML = '<span class="badge bg-secondary">Running‚Ä¶</span>';
  stdoutBox.textContent = '';
  stderrBox.textContent = '';

  btn.classList.remove('btn-primary', 'btn-outline-primary');
  btn.classList.add('btn-danger');
  btn.textContent = "‚è≥ Syncing...";

  try {
    const res = await fetch(`/run-sync/${encodeURIComponent(dbName)}`);
    const data = await res.json();

    if (data.status === 'success') {
      statusBadge.innerHTML = '<span class="badge bg-success">Success</span>';
    } else {
      statusBadge.innerHTML = '<span class="badge bg-danger">Error</span>';
    }

    stdoutBox.textContent = data.stdout || '';
    stderrBox.textContent = data.stderr || (data.error || '');
  } catch (err) {
    statusBadge.innerHTML = '<span class="badge bg-danger">Error</span>';
    stderrBox.textContent = String(err);
  } finally {
    btn.classList.remove('btn-danger');
    btn.classList.add('btn-primary');
    btn.textContent = "‚ñ∂ Run Sync";
  }
}

async function addServer() {
  const name = document.getElementById("serverName").value;
  const host = document.getElementById("serverHost").value;
  const username = document.getElementById("serverUser").value;
  const password = document.getElementById("serverPass").value;

  const res = await fetch("/api/sqlservers/add", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({name, server: host, username, password})
  });
  const data = await res.json();

  if (data.status === "ok") {
    alert("Server added successfully!");
    const dbList = document.querySelector("#availableDatabases");

    data.databases.forEach(db => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary">Unknown</span>
          <a href="/database/${db}" class="text-decoration-none">üóÑÔ∏è ${db}</a>
        </div>
        <div class="btn-group">
          <button id="syncBtn-${db}" class="btn btn-sm btn-primary" onclick="runSync('${db}')">‚ñ∂ Run Sync</button>
        </div>`;
      dbList.appendChild(li);
    });
  } else {
    alert("Error adding server: " + data.error);
  }
}
</script>
</body>
</html>
