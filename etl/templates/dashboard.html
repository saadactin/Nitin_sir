<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Migration Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="d-flex">
 {% include 'navbar.html' %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3">ðŸš€ Migration Dashboard</h1>
      <a href="/" class="btn btn-outline-secondary">Back</a>
    </div>

    <!-- Latest Run -->
    <div class="card mb-4">
      <div class="card-header">Latest Run</div>
      <div class="card-body">
        {% if data.latest_run %}
          <div class="row g-3">
            <div class="col-md-4"><b>Run ID:</b> {{ data.latest_run.run_id }}</div>
            <div class="col-md-2"><b>Status:</b> {{ data.latest_run.status }}</div>
            <div class="col-md-3"><b>Start:</b> {{ data.latest_run.start_time }}</div>
            <div class="col-md-3"><b>End:</b> {{ data.latest_run.end_time }}</div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-md-2"><b>Servers:</b> {{ data.latest_run.total_servers }}</div>
            <div class="col-md-2"><b>DBs:</b> {{ data.latest_run.total_databases }}</div>
            <div class="col-md-2"><b>Tables:</b> {{ data.latest_run.total_tables }}</div>
            <div class="col-md-3"><b>Rows Processed:</b> {{ data.latest_run.total_rows_processed }}</div>
            <div class="col-md-3"><b>Rows Inserted:</b> {{ data.latest_run.total_rows_inserted }}</div>
          </div>
          <div class="mt-2">
            <span class="badge bg-success me-2">Success: {{ data.latest_run.successful_syncs }}</span>
            <span class="badge bg-danger">Failed: {{ data.latest_run.failed_syncs }}</span>
          </div>
        {% else %}
          <p class="mb-0 text-muted">No migration runs yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- Recent Runs -->
    <div class="card mb-4">
      <div class="card-header">Recent Runs</div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Type</th>
              <th>Status</th>
              <th>Start</th>
              <th>End</th>
              <th>Inserted</th>
              <th>Success</th>
              <th>Failed</th>
            </tr>
          </thead>
          <tbody>
            {% for run in data.recent_runs %}
            <tr>
              <td class="text-truncate" style="max-width: 280px;">{{ run.run_id }}</td>
              <td>{{ run.run_type }}</td>
              <td>
                <span class="badge {% if run.status == 'COMPLETED' %}bg-success{% elif run.status == 'FAILED' %}bg-danger{% else %}bg-secondary{% endif %}">
                  {{ run.status }}
                </span>
              </td>
              <td>{{ run.start_time }}</td>
              <td>{{ run.end_time }}</td>
              <td>{{ run.total_rows_inserted }}</td>
              <td>{{ run.successful_syncs }}</td>
              <td>{{ run.failed_syncs }}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-muted">No recent runs.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Active Alerts -->
    <div class="card mb-4">
      <div class="card-header text-danger">Active Alerts</div>
      <ul class="list-group list-group-flush">
        {% for alert in data.active_alerts %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <b>{{ alert.severity }}</b> â€” {{ alert.alert_type if alert.alert_type else '' }}
              <div class="small text-muted">
                {{ alert.server_name }} / {{ alert.database_name }} / {{ alert.table_name }}
              </div>
              <div>{{ alert.message }}</div>
            </div>
            <div class="text-muted small">{{ alert.timestamp }}</div>
          </div>
        </li>
        {% else %}
        <li class="list-group-item">âœ… No active alerts</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Consistency Issues -->
    <div class="card mb-4">
      <div class="card-header text-warning">Data Consistency Issues</div>
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Server</th>
              <th>Database</th>
              <th>Table</th>
              <th>Source</th>
              <th>Target</th>
              <th>Missing</th>
              <th>%</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for issue in data.consistency_issues %}
            <tr>
              <td>{{ issue.server_name }}</td>
              <td>{{ issue.database_name }}</td>
              <td>{{ issue.table_name }}</td>
              <td>{{ issue.source_count }}</td>
              <td>{{ issue.target_count }}</td>
              <td>{{ issue.missing_rows }}</td>
              <td>{{ issue.consistency_percentage }}</td>
              <td>
                <span class="badge {% if issue.status == 'FAIL' %}bg-danger{% elif issue.status == 'WARNING' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                  {{ issue.status }}
                </span>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-muted">No issues found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- System Health -->
    <div class="card">
      <div class="card-header">System Health (latest run)</div>
      <ul class="list-group list-group-flush">
        {% for metric in data.system_health %}
        <li class="list-group-item d-flex justify-content-between">
          <div>{{ metric.metric_name }}</div>
          <div>{{ metric.value }} {{ metric.unit }}</div>
        </li>
        {% else %}
        <li class="list-group-item text-muted">No metrics yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  </div>
</body>
</html>
