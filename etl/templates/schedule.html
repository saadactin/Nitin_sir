<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Schedule Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/migration_schedule.css" rel="stylesheet">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    {% include 'navbar.html' %}

    <!-- Main Content -->
    <main class="content p-4 flex-grow-1">
      <h1 class="mb-4">‚è∞ Schedule Sync</h1>

      <!-- Add Schedule Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">New Schedule</div>
        <div class="card-body">
          <form id="scheduleForm">
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">SQL Server</label>
                <select class="form-select" name="server" required>
                  {% for server in sqlservers.keys() %}
                    <option value="{{ server }}">{{ server }}</option>
                  {% endfor %}
                </select>
              </div>
            <div class="col-md-4">
  <label class="form-label">Database</label>
  <select class="form-select" name="database" id="databaseSelect" required>
    <option value="">Select a database</option>
  </select>
</div>

              <div class="col-md-4">
                <label class="form-label">Schedule Type</label>
                <select class="form-select" name="type" id="scheduleType">
                  <option value="interval">Every X minutes/hours</option>
                  <option value="cron">Specific time</option>
                </select>
              </div>
            </div>

            <div id="intervalFields" class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Every (minutes)</label>
                <input type="number" name="minutes" class="form-control" min="1" value="60">
              </div>
            </div>

            <div id="cronFields" class="row mb-3" style="display:none;">
              <div class="col-md-6">
                <label class="form-label">Time (HH:MM, 24h)</label>
                <input type="time" name="time" class="form-control">
              </div>
            </div>

            <button type="submit" class="btn btn-success">‚ûï Add Schedule</button>
          </form>
        </div>
      </div>

      <!-- Existing Schedules -->
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">Existing Schedules</div>
        <div class="card-body">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Server</th>
                <th>Database</th>
                <th>Type</th>
                <th>Details</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="scheduleList">
              {% for job in schedules %}
                <tr>
                  <td>{{ job.server }}</td>
                  <td>{{ job.database }}</td>
                  <td>{{ job.type }}</td>
                  <td>{{ job.details }}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule('{{ job.id }}')">üóë Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
<script>
  // ---------------- Fetch Databases for a Selected Server ----------------
  async function fetchDatabases(serverName) {
    const dbSelect = document.getElementById("databaseSelect");
    dbSelect.innerHTML = '<option value="">Loading...</option>';

    try {
      const res = await fetch(`/api/databases/${serverName}`);
      if (!res.ok) throw new Error("Failed to fetch databases");

      const data = await res.json();
      dbSelect.innerHTML = '<option value="">Select a database</option>';
      data.forEach(db => {
        const option = document.createElement("option");
        option.value = db.name;
        option.textContent = db.name;
        dbSelect.appendChild(option);
      });
    } catch (err) {
      dbSelect.innerHTML = '<option value="">Error loading databases</option>';
      console.error(err);
    }
  }

  // Listen for server selection change
  const serverSelect = document.querySelector('select[name="server"]');
  serverSelect.addEventListener("change", function () {
    const server = this.value;
    if (server) {
      fetchDatabases(server);
    } else {
      const dbSelect = document.getElementById("databaseSelect");
      dbSelect.innerHTML = '<option value="">Select a database</option>';
    }
  });

  // Auto-load databases for initially selected server
  window.addEventListener("DOMContentLoaded", function () {
    if (serverSelect.value) {
      fetchDatabases(serverSelect.value);
    }
  });

  // ---------------- Toggle Interval / Cron Fields ----------------
  document.getElementById("scheduleType").addEventListener("change", function () {
    if (this.value === "interval") {
      document.getElementById("intervalFields").style.display = "flex";
      document.getElementById("cronFields").style.display = "none";
    } else {
      document.getElementById("intervalFields").style.display = "none";
      document.getElementById("cronFields").style.display = "flex";
    }
  });

  // ---------------- Add New Schedule ----------------
  document.getElementById("scheduleForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
      const res = await fetch("/api/schedule/add", {
        method: "POST",
        body: formData
      });
      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert("Error adding schedule: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      console.error(err);
      alert("Error adding schedule: " + err.message);
    }
  });

  // ---------------- Delete Schedule ----------------
  async function deleteSchedule(jobId) {
    try {
      await fetch(`/api/schedule/delete/${jobId}`, { method: "DELETE" });
      location.reload();
    } catch (err) {
      console.error(err);
      alert("Error deleting schedule: " + err.message);
    }
  }
</script>

</body>
</html>
