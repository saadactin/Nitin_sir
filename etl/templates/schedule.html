<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Schedule Sync</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/migration_schedule.css" rel="stylesheet">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    {% include 'navbar.html' %}

    <!-- Main Content -->
    <main class="content p-4 flex-grow-1">
      <h1 class="mb-4">‚è∞ Schedule Sync</h1>

      <!-- Add Schedule Form -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">New Schedule</div>
        <div class="card-body">
          <form id="scheduleForm">
            <div class="row mb-3">
              <!-- Server -->
              <div class="col-md-4">
                <label class="form-label">SQL Server</label>
                <select class="form-select" name="server" id="server" required>
                  {% for server, dbs in sqlservers.items() %}
                    <option value="{{ server }}">{{ server }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Sync Scope -->
              <div class="col-md-4">
                <label class="form-label">Sync Scope</label>
                <select id="targetType" name="targetType" class="form-select" required>
                  <option value="server">Whole Server</option>
                  <option value="database">Single Database</option>
                </select>
              </div>

              <!-- Database dropdown (hidden by default) -->
              <div class="col-md-4" id="databaseGroup" style="display:none;">
                <label class="form-label">Database</label>
                <select id="database" name="database" class="form-select">
                  {% for server, dbs in sqlservers.items() %}
                    {% for db in dbs %}
                      <option value="{{ db }}" data-server="{{ server }}">{{ db }}</option>
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <!-- Schedule Type -->
              <div class="col-md-4">
                <label class="form-label">Schedule Type</label>
                <select class="form-select" name="type" id="scheduleType">
                  <option value="interval">Every X minutes</option>
                  <option value="daily">Daily at specific time</option>
                </select>
              </div>

              <!-- Interval Fields -->
              <div class="col-md-4" id="intervalGroup">
                <label class="form-label">Every (minutes)</label>
                <input type="number" name="minutes" id="minutes" class="form-control" min="1" value="60">
              </div>

              <!-- Daily Fields -->
              <div class="col-md-4" id="dailyGroup" style="display:none;">
                <label class="form-label">Time (HH:MM, 24h)</label>
                <input type="time" name="time" id="time" class="form-control" value="02:00">
              </div>
            </div>

            <button type="submit" class="btn btn-success">‚ûï Add Schedule</button>
          </form>
        </div>
      </div>

      <!-- Existing Schedules -->
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">Existing Schedules</div>
        <div class="card-body">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Server</th>
                <th>Database</th>
                <th>Type</th>
                <th>Details</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="scheduleList">
              {% for job in schedules %}
                <tr>
                  <td>{{ job.server }}</td>
                  <td>{{ job.database or "ALL DATABASES" }}</td>
                  <td>{{ job.type }}</td>
                  <td>{{ job.details }}</td>
                  <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteSchedule('{{ job.id }}')">üóë Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Toggle database dropdown based on Sync Scope
    document.getElementById("targetType").addEventListener("change", function() {
      if (this.value === "database") {
        document.getElementById("databaseGroup").style.display = "block";
      } else {
        document.getElementById("databaseGroup").style.display = "none";
        document.getElementById("database").value = ""; // reset
      }
    });

    // Toggle interval vs daily input fields
    document.getElementById("scheduleType").addEventListener("change", function() {
      if (this.value === "interval") {
        document.getElementById("intervalGroup").style.display = "block";
        document.getElementById("dailyGroup").style.display = "none";
      } else {
        document.getElementById("intervalGroup").style.display = "none";
        document.getElementById("dailyGroup").style.display = "block";
      }
    });

    // Submit new schedule
    document.getElementById("scheduleForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      // If "Whole Server" selected, remove database field
      if (formData.get("targetType") === "server") {
        formData.set("database", "");
      }

      const res = await fetch("/api/schedule/add", {
        method: "POST",
        body: formData
      });
      if (res.ok) location.reload();
    });

    // Delete schedule
    async function deleteSchedule(jobId) {
      await fetch(`/api/schedule/delete/${jobId}`, { method: "DELETE" });
      location.reload();
    }
  </script>
</body>
</html>
